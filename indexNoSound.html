<!DOCTYPE html>

<html>
    <head>
        <title>20-20-20 Rule</title>
        <script type="text/javascript" src="js/stopwatch.js"></script>
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen"/>
        <link href="main.css" rel="stylesheet" media="screen"/>
        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="bootstrap/js/bootstrap.min.js"></script>

    </head>

    <body>
    <div class="container">
        <div id="watchText">Time to next break:</div>
        <div id="watchDisplay">Watch's display (handeled by JavaScript)</div>
        <button type="button" class="btn btn-primary" id="resetButton" onclick="window.startAfresh()">Reset clock</button>

        <div>
            <label for="normalDurationMins" class="col-sm-2 control-label">Normal working period (minutes)</label>
            <div class="col-sm-1">
                <input class="form-control" id="normalDurationMins" placeholder="20">
            </div>
        </div>
        <div>
            <label for="relaxDurationSecs" class="col-sm-2 control-label">Duration of break (seconds)</label>
            <div class="col-sm-1">
                <input class="form-control" id="relaxDurationSecs" placeholder="20">
            </div>
        </div>
        <div>
            <div class="col-sm-offset-2 col-sm-1">
                <button  class="btn btn-default" onclick="modifyTimes()">Apply</button> 
                <!-- TODO: modifyTimes -> ApplyModification -->
            </div>
        </div>
        <br><br>
        <p><a href="index.html">Go back</a> to get alerted via sound.</p>
    </div>
        <script>
            window.watch = new Stopwatch(function(watch) { // Listener function
                document.getElementById('watchDisplay').innerHTML = watch.toString();
            } , 1000, false);

            /* When normalPeriod is 1, the user can carry on his tasks on computer, but when it
             * is 0, we'll alert the user to not look at the screen and relax his/her eyes. */
            window.isNormalPeriod = 1;  // used as boolean
            window.normalPeriodLengthMilliSec = 1000*60*20;    // 20 minutes
            window.relaxPeriodLengthMilliSec = 1000*20;          // 20 seconds
            poppedUpWindow = 'dummyValue';
            //temporary values 
            window.normalPeriodLengthMilliSec = 1000*10; window.relaxPeriodLengthMilliSec = 1000*2;

//            window.soundFile1 = new Audio("sounds/bing.ogg");
//            window.soundFile2 = new Audio("sounds/bong.ogg");

            function readFromCookie() {
                var normalPeriodFromCookieMilliSec = readCookie("normalPeriodCookieMilliSec");
                var relaxPeriodFromCookieMilliSec = readCookie("relaxPeriodCookieMilliSec");

                if(normalPeriodFromCookieMilliSec) {
                    window.normalPeriodLengthMilliSec = normalPeriodFromCookieMilliSec;
                    document.getElementById('normalDurationMins').value = normalPeriodFromCookieMilliSec/1000/60;
                }

                if(relaxPeriodFromCookieMilliSec) {
                    window.relaxPeriodLengthMilliSec = relaxPeriodFromCookieMilliSec;
                    document.getElementById('relaxDurationSecs').value = relaxPeriodFromCookieMilliSec/1000;
                }
            }

            readFromCookie();

            var watchTextValues = ["Don't look at the screen!!", "Time to next break:"];

            window.startAfresh = function() {
                setDisplayForBool(window.isNormalPeriod);
                clearIntervalsAndTimeouts();
                resetWatch(window.normalPeriodLengthMilliSec);
                window.alreadySetInterval = setInterval('loop()', window.normalPeriodLengthMilliSec);
                if (poppedUpWindow !== 'dummyValue') {poppedUpWindow.close();}
            }

            window.startAfresh();

            function modifyTimes() {
                var normalCookieStr = document.getElementById('normalDurationMins').value;
                var relaxCookieStr = document.getElementById('relaxDurationSecs').value;

                if(isNaN(Number(normalCookieStr)) || isNaN(Number(relaxCookieStr))) {
                    alert("Please check the number you have entered.");
                    return;
                }

                // Rounding off to fall at the edge of a second
                var normalMilli = Math.round(Number(normalCookieStr)*60*1000/1000)*1000;
                var relaxMilli = Math.round(Number(relaxCookieStr)*1000/1000)*1000;

                if(relaxMilli >= normalMilli) {
                    alert("Duration of break can't be more than or equal to normal working period :)");
                    return;
                }

                window.normalPeriodLengthMilliSec = normalMilli;
                window.relaxPeriodLengthMilliSec = relaxMilli;

                createCookie("normalPeriodCookieMilliSec", window.normalPeriodLengthMilliSec, 365*20);
                createCookie("relaxPeriodCookieMilliSec", window.relaxPeriodLengthMilliSec, 365*20);

                window.startAfresh();
            }

            function clearIntervalsAndTimeouts() {
                clearInterval(window.alreadySetInterval);
                clearTimeout(window.alreadySetTimeout);
            }

            function loop() {
                resetWatch(window.normalPeriodLengthMilliSec);
                executeBothTasksWithDelay();
            }

            function resetWatch(timeMilliSec) {
                window.watch.stop();
                window.watch.setElapsed(0, 0, timeMilliSec/1000);
                window.watch.start();
                document.getElementById('watchDisplay').innerHTML = window.watch.toString();
            }

            function executeBothTasksWithDelay() {
//                window.soundFile1.play();
                resetWatch(window.relaxPeriodLengthMilliSec);
                setDisplayForBool(0);
                poppedUpWindow = window.open('popupPage.html', '', config='height=300,width=300');
                window.alreadySetTimeout = setTimeout(function(){
//                    window.soundFile2.play();
                    resetWatch(window.normalPeriodLengthMilliSec - window.relaxPeriodLengthMilliSec);
                    setDisplayForBool(1);
                    poppedUpWindow.close();
                }, window.relaxPeriodLengthMilliSec);
            }

            function setDisplayForBool(boolVal) {
                if(boolVal==1) {
                    watchColour = "#008080";
                } else if(boolVal==0) {
                    watchColour = "#FF3366";
                }
                document.getElementById('watchDisplay').style.color = watchColour;
                document.getElementById('watchText').innerHTML = watchTextValues[boolVal];
            }

            // Cookie operations
            // Borrowed from www.quirksmode.org/js/cookies.html
            function createCookie(cookieName, cookieValue, cookieExpiryDays) {
                if(cookieExpiryDays) {
                    var date = new Date();
                    date.setTime(date.getTime()+cookieExpiryDays*24*60*60*1000);
                    var expires = '; expires='+date.toGMTString();
                } else var expires = "";
                document.cookie = cookieName+'='+cookieValue+expires+'; path=/';
            }

            function readCookie(cookieName) {
                //TODO(rushiagr): optimize this function
                var cookieNameEQ = cookieName+'=';
                var cookieArray = document.cookie.split(';');
                for(var i=0; i<cookieArray.length; i++) {
                    var cookie = cookieArray[i];
                    while (cookie.charAt(0)==' ')
                        cookie = cookie.substring(1, cookie.length);
                    if(cookie.indexOf(cookieNameEQ)==0)
                        return cookie.substring(cookieNameEQ.length, cookie.length);
                }
                return null;
            }

            function eraseCookie(cookieName) {
                createCookie(cookieName, "", -1);
            }

        </script>
    </body>
</html>
